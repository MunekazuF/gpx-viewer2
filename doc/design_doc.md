# GPX Viewer SPA 設計書

## 1. 概要

GPXファイルをアップロードし、内容を解析、地図上に軌跡を表示するSPA（Single Page Application）を開発する。

## 2. アーキテクチャ

### 2.1. コンポーネント設計

本アプリケーションは、Reactのコンポーネントベースのアーキテクチャを採用する。責務の分離を明確にするため、UIとロジックを以下のコンポーネントに分割する。

-   **`App.js`**: アプリケーション全体のレイアウトと状態管理の起点。各コンポーネントを統合する。
-   **`Sidebar.js`**: GPXファイルのアップロード、ファイル一覧の表示、選択、削除、フィルタリングといったファイル管理機能全般を担当する。
-   **`FilterModal.js`**: ファイル一覧を絞り込むための条件（キーワード、日付範囲など）を設定するポップアップを担当する。
-   **`GpxInfoOverlay.js`**: 選択されたGPXファイルの詳細情報（距離、標高、時間など）を表示するオーバーレイを担当する。
-   **`ElevationGraph.js`**: 選択されたGPXデータの標高グラフの描画を担当する。
-   **`useMap.js` (カスタムフック)**: Leafletマップの初期化、レイヤーの追加・削除・スタイル更新など、マップ操作に関連するロジックをカプセル化する。
-   **`useGpx.js` (カスタムフック)**: GPXファイルの管理、パース、状態管理（選択、フォーカス）に関連するロジックをカプセル化する。
-   **`useUI.js` (カスタムフック)**: レスポンシブ対応、レイアウトの状態管理（サイドバー、グラフ表示モード）に関連するロジックをカプセル化する。

### 2.2. データフロー

1.  ユーザーが`Sidebar`コンポーネント経由でGPXファイルをアップロードする。
2.  `App.js`がファイルを受け取り、`gpxParser.js`に渡してデータを解析させる。
3.  解析されたデータ（軌跡情報、メタデータ）は`App.js`のstateとして保持され、`IndexedDB`に永続化される。
4.  `App.js`は`useMap`フックを呼び出し、地図上に軌跡レイヤーを追加する。
5.  `App.js`は`ElevationGraph`コンポーネントにグラフ用データを渡し、標高グラフを描画させる。
6.  ユーザーがファイル一覧のチェックボックスをクリックすると、軌跡の表示/非表示が切り替わる。
7.  ユーザーがファイル名をクリックすると、その軌跡にフォーカスが当たり、地図が移動し、情報オーバーレイが更新される。

### 2.3. ワイヤーフレーム
- @"D:\work\map\gpx-viewer2\doc\IMG_5285.PNG"

## 3. 機能要件

### 3.1. GPXファイル管理

-   **ファイルアップロード:**
    -   ファイル選択ダイアログからGPXファイルを選択できる。
    -   ドラッグ＆ドロップでGPXファイルをアップロードできる。
    -   一度に複数のファイルをアップロードできる。
    -   同じファイルがアップロードされた場合は無視する（ファイル名で重複を判断）。
-   **データ表示・操作:**
    -   アップロードされたGPXファイルの一覧をサイドバーに表示する。
    -   一覧の表示フォーマット: `yyyy/mm/dd ファイル名`
    -   **チェックボックス**: クリックで軌跡の表示/非表示を切り替える。複数選択が可能。
    -   **ファイル名**: クリックで該当の軌跡にフォーカスし、地図を移動させ、情報を表示する。
-   **フィルター機能:**
    -   サイドバーのフィルターアイコン（▼）をクリックすると、絞り込み条件を設定するポップアップが表示される。
    -   **キーワード**: ファイル名に含まれる文字で絞り込む。
    -   **日付範囲**: GPXのスタート日で期間絞り込みを行う。
    -   **地図範囲**: 「適用」ボタンを押した時点の地図表示範囲内に、スタート地点またはゴール地点が含まれる軌跡のみに絞り込む。
-   **選択操作:**
    -   **リセットボタン**: ファイル一覧のチェックボックス選択をすべて解除する。
    -   **削除ボタン**: 選択されているすべてのファイルを削除する。ボタンは赤色で表示する。
-   **データ永続化:**
    -   アップロードされたGPXデータは、ブラウザの`IndexedDB`に保存し、リロード後も保持される。

### 3.2. 地図表示

-   **ベースマップ:**
    -   OpenStreetMapをデフォルトの地図として使用する。
-   **タイル切り替え:**
    -   以下のベースマップを切り替える機能を追加する。
        -   OpenStreetMap (標準)
        -   OpenStreetMap Japan
        -   国土地理院
-   **軌跡表示:**
    -   GPXデータの軌跡を地図上にポリラインとして表示する。
    -   サイドバーで選択されているデータのみ表示される。
    -   軌跡の線のスタイルは以下の通りとする。
        -   **デフォルトの色**: ビビッドなランダムカラー（緑系は除く）
        -   デフォルトの太さ: 3px
        -   選択時の太さ: 5px
-   **マーカー表示:**
    -   軌跡のスタート地点とゴール地点にマーカーを表示する。
-   **地図コントロール:**
    -   **縮尺（スケール）:** 左下に表示する。
    -   **拡大・縮小（ズーム）:** 右下に表示する。
    -   **タイル切り替え:** 右下に表示する。
-   **インタラクション:**
    -   ファイル一覧のチェックボックスをONにすると、該当の軌跡がハイライトされ（線が太くなる）、地図がその軌跡の全体像にズームする。
    -   地図上の軌跡をクリックすると、その軌跡にフォーカスが当たり、地図が移動し、情報が表示される（選択状態は変わらない）。
    -   選択された軌跡（最後にチェックをONにしたもの、または最後にクリックされたもの）の情報が地図右上のオーバーレイに表示される。
    -   情報オーバーレイが表示されているときに、再度同じ軌跡をクリックするか、情報オーバーレイ自体をクリックすると、オーバーレイは非表示になる。
    -   タッチデバイスでの操作性を向上させるため、`Leaflet Touch Helper`を導入し、軌跡のタップ判定を拡大する。

### 3.3. グラフ表示
-   サイドバーでデータを選択すると通常表示される。
-   サイドバーで選択されたデータのみ標高グラフを重ねて表示する。
-   グラフコントロールのボタンで、表示モードを「**トラック**（通常の標高）」「**標高差**」「**獲得標高**」の3種類にトグルで切り替えられる。

### 3.4. UI/レイアウト

本アプリケーションは、多様なデバイスで最適なユーザー体験を提供するため、レスポンシブデザインを採用する。

-   **レイアウト構成:**
    -   **ワイドスクリーン時 (デスクトップなど、幅769px以上):**
        -   画面は「サイドバー」と「メインエリア（地図とグラフ）」の2つのペインに左から順に分割される。
        -   メインエリアはさらに「地図表示エリア」と「標高グラフエリア」の2つのペインに縦に分割される。
        -   サイドバーは常に表示され、ファイル操作を容易にする。初期表示幅は`300px`とする。
    -   **ナロースクリーン時 (スマートフォンなど、幅768px以下):**
        -   地図とグラフをメインに表示する。
        -   サイドバーは画面外からスライドイン/アウトするオーバーレイとして機能し、ハンバーガーメニュー等で表示を切り替える。
-   **リサイズ・最小化機能 (ワイドスクリーン時):**
    -   **サイドバー:**
        -   ユーザーはドラッグ操作でサイドバーの幅を自由に変更できる。
        -   サイドバーには折りたたみボタン（`<`）を、地図エリアには展開ボタン（`>`）を設け、クリックでサイドバーの表示・非表示を切り替えられる。
    -   **標高グラフ:**
        -   ユーザーはドラッグ操作で地図とグラフの境界線を動かし、それぞれの高さを自由に変更できる。
        -   従来の最大化・最小化・通常表示の切り替え機能も維持する。
-   **情報オーバーレイ:**
    -   PC・スマホ問わず、画面の`top: 10px`, `right: 50px`に固定表示する。

### 3.5. バージョン
-   **バージョン管理:**
    -   package.jsonのversionをプロジェクトバージョンとする
    -   サイドバー右下にバージョンを表示する

## 4. 技術仕様

-   **フロントエンドフレームワーク:** React (Hooks)
-   **地図ライブラリ:** Leaflet.js, Leaflet-gpx, leaflet-touch-helper
-   **グラフライブラリ:** Chart.js
-   **レイアウト分割ライブラリ:** Split.js
-   **GPX解析:** DOMParser
-   **データ永続化:** IndexedDB (idbライブラリ使用)
-   **スタイリング:** CSS

## 5. 隠し機能

-   **全データ削除:**
    -   サイドバーに表示されているバージョン情報をクリックすると、「データを完全に削除します」という確認ダイアログが表示される。
    -   「はい」を選択すると、IndexedDBに保存されているすべてのGPXデータが削除され、アプリケーションがリロードされる。
-   **アップロード時の選択制限:**
    -   一度に21個以上のファイルをアップロードした場合、自動で選択状態になるのは最初の20個までとする。残りのファイルはリストに追加されるが、選択はされない。
